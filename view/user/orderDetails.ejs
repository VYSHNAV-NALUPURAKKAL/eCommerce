<%- include('userLayouts/header') %>
<div style="width: 100%; height: 77px; background-color: white;"></div>
<nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
    <div class="container">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/profile">My Account</a></li>
            <li class="breadcrumb-item active" aria-current="page">Order</li>
        </ol>
    </div><!-- End .container -->
</nav><!-- End .breadcrumb-nav -->


<main class="main">
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <h3 class="card-title">Delivery Address</h3>
                        <p>Name: <%= orderDetails.deliveryAddress[0].fullName %><br>
                        Email: <%= orderDetails.deliveryAddress[0].email %><br>
                        Mobile: <%= orderDetails.deliveryAddress[0].mobile %><br>
                        State: <%= orderDetails.deliveryAddress[0].state %><br>
                        City: <%= orderDetails.deliveryAddress[0].city %><br>
                        House Name: <%= orderDetails.deliveryAddress[0].houseName %><br>
                        Pincode: <%= orderDetails.deliveryAddress[0].pin %><br>
                        <!-- <a href="/editAddress" >Edit <i class="icon-edit"></i></a> -->
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-dashboard">
                    <div class="card-body" id="xs">
                        <h3 class="card-title">Order Summary</h3>
                        <p>OrderId: <%= orderDetails._id %><br>
                        Date: <%= orderDetails.orderDate.toLocaleDateString('en-US', { year:'numeric', month: 'short', day: '2-digit'}).replace(/\//g, '-') %><br>
                        Items: <%= orderDetails.products.length %><br>
                        Shipping:<%= orderDetails.deliveryAddress[0].pin %><br>
                        Total Amount: <%= orderDetails.subTotal %><br>
                        Payment Method: <%= orderDetails.payment %><br>
                        Status:<span id="orderStatus"> <%= orderDetails.orderStatus %></span><br>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-b-45">
            <h4 class="ltext-106 cl5 txt-center">
                 Products
            </h4>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="card card-dashboard">
                    <div class="card-body">
                        <div class="table-responsive">
                            <% console.log("product image :",orderDetails.products)%>
                            <table class="table table-hover">
                                <tbody>
                                    <%

    const uniqueProductsMap = new Map();
    
   
    orderDetails.products.forEach(function(product) {
        const productId = product.productId._id;
        if (uniqueProductsMap.has(productId)) {

            const existingProduct = uniqueProductsMap.get(productId);
            existingProduct.quantity += product.quantity;
            existingProduct.totalPrice += product.totalPrice;
        } else {
            
            uniqueProductsMap.set(productId, {
                product: product,
                quantity: product.quantity,
                totalPrice: product.totalPrice
            });
        }
    });
%>

<% 
   
    uniqueProductsMap.forEach(function(productInfo) {
        const product = productInfo.product;
%>
    <tr>
        <td>
            <img src="/public/adminAssets/product-images/<%= product.productId.images[0] %>" alt="" class="img-thumbnail" style="max-width: 80px;">
        </td>
        <td>
            <a href="/product?_id=<%= product.productId %>"><%= product.productId.name %></a>
        </td>                                          
        <td><%= product.productId.category %></td>
        <td> ₹<%= product.price %></td>
        <td><%= productInfo.quantity %></td>
        <td> ₹<%= productInfo.totalPrice %></td>
        <td>
            <% if (product.productStatus === 'placed' ) { %>
                <button id="cancelButton" onclick="cancelProduct('<%= product.productId._id %>','<%= orderDetails._id %>')">Cancel</button>
            <% } else { %>
                <span>No Actions Available</span>
            <% } %>
        </td>
    </tr>
<% }); %>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function cancelProduct(x,y){
                const productId = x;
                const orderId = y;
                console.log("order id from fronted :",orderId);
                fetch("/cancelProductStatus",{
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify({productId,orderId})
                })
                .then((response)=>response.json())
                .then((data)=>{
                    if (data.update === true) {
                            console.log("helloooo inside e");
                            const cancelButton = document.getElementById('cancelButton');
                            cancelButton.textContent = 'No Actions Available';

                        }
                        console.log("order id :",orderId);
                        $('#xs').load(`/orderDetails?_id=${orderId} #xs`);    

                    })
                .catch((error)=>{
                    console.log(
                    "error on cancelProduct :",error
                    );
                })
            }
        </script>


<%- include('userLayouts/footer') %>